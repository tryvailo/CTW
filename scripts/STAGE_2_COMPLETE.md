# ‚úÖ –≠—Ç–∞–ø 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TreatmentConnect - –ó–ê–í–ï–†–®–ï–ù

**–î–∞—Ç–∞:** 2025-11-07  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 2.1 –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è extractTreatmentConnectPrices() ‚úÖ

**–§–∞–π–ª:** `scripts/scraper.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TreatmentConnect —Å—Ö–µ–º—É –∏–∑ `schemas/treatmentconnect-schema.js`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–º–ø—Ç—ã –∏–∑ `config/prompts-config.js`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `treatmentconnect-config.js`
- ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç CSV
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ —Ü–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (hospital_name, rating, avg_uk_price)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç null –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–¥–ª—è fallback)

### 2.2 –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è scrapePrivateCosts() ‚úÖ

**–§–∞–π–ª:** `scripts/scraper.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –∏–∑ `scrapePHINData()` –≤ `scrapePrivateCosts()` (–±–æ–ª–µ–µ –æ–±—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: TreatmentConnect ‚Üí PHIN ‚Üí Regex ‚Üí CSV
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ TreatmentConnect URL
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ URL –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ (`config/load-urls.js`)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö URL –¥–ª—è –æ–¥–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ city/procedure

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:**
1. **TreatmentConnect** (PRIMARY) - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
2. **PHIN JSON Mode** (FALLBACK 1) - –µ—Å–ª–∏ TreatmentConnect –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. **Regex Parser** (FALLBACK 2) - –µ—Å–ª–∏ JSON Mode –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **CSV Fallback** (FALLBACK 3) - –µ—Å–ª–∏ –≤—Å–µ –º–µ—Ç–æ–¥—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏

### 2.3 –°–æ–∑–¥–∞–Ω Batch Processor ‚úÖ

**–§–∞–π–ª:** `scripts/batch-processor.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ URL –±–∞—Ç—á–∞–º–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä)
- ‚úÖ Rate limiting –º–µ–∂–¥—É URL –∏ –±–∞—Ç—á–∞–º–∏
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-—Ç—Ä–µ–∫–∏–Ω–≥
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –∏–∑–≤–ª–µ—á–µ–Ω–∏–π
- ‚úÖ Callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–§—É–Ω–∫—Ü–∏–∏:**
- `processBatch(processUrl, options)` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö URL –±–∞—Ç—á–∞–º–∏
- `processCityProcedure(processUrl, city, procedure, options)` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏):**
- Batch size: 5 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- Delay between URLs: 6 —Å–µ–∫—É–Ω–¥ (–∏–∑ config.scraping.rate_limit_delay)
- Delay between batches: 10 —Å–µ–∫—É–Ω–¥
- Max retries: 2

### 2.4 –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç ‚úÖ

**–§–∞–π–ª:** `scripts/test-treatmentconnect.js`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 3-5 URL –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `extractTreatmentConnectPrices()`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- ‚úÖ Rate limiting –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–Ω–µ—à–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```javascript
// –°—Ö–µ–º–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
const schema = schemas.treatmentConnect.schema;

// –ü—Ä–æ–º–ø—Ç –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞
const prompt = schemas.treatmentConnect.getPrompt(procedure, city);

// URL –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ JSON
const urls = getTreatmentConnectUrls(city.toLowerCase(), procedure);

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
const priceRanges = treatmentConnectConfig.validation.price_ranges[procedure];
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

```javascript
// PRIORITY 1: TreatmentConnect (PRIMARY)
costData = await extractTreatmentConnectPrices(url, procedure, city);

// PRIORITY 2: PHIN (FALLBACK)
if (!costData) {
  costData = await extractPHINCostsWithJSONMode(phinUrl, procedure, city);
}

// PRIORITY 3: Regex Parser (FALLBACK)
if (!costData) {
  costData = parsePHINCosts(html, markdown, procedure, city);
}

// PRIORITY 4: CSV Fallback (FALLBACK)
if (!costData) {
  costData = getFallbackData('private_costs').filter(...);
}
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `extractTreatmentConnectPrices()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω –∏–∑ TreatmentConnect
- `processBatch()` - batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ URL
- `processCityProcedure()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `scrapePrivateCosts()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TreatmentConnect

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `scripts/batch-processor.js` - batch –æ–±—Ä–∞–±–æ—Ç–∫–∞
- `scripts/test-treatmentconnect.js` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏:
```bash
‚úÖ scripts/scraper.js - –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ scripts/batch-processor.js - –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ scripts/test-treatmentconnect.js - –±–µ–∑ –æ—à–∏–±–æ–∫
```

### –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `extractTreatmentConnectPrices()` —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- ‚úÖ –í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–≠—Ç–∞–ø 3)

1. ‚è≠Ô∏è –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 3-5 —Ä–µ–∞–ª—å–Ω—ã—Ö URL
2. ‚è≠Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
3. ‚è≠Ô∏è –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
4. ‚è≠Ô∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:
- ‚úÖ –í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö (–Ω–µ –≤ –∫–æ–¥–µ)
- ‚úÖ TreatmentConnect - PRIMARY –∏—Å—Ç–æ—á–Ω–∏–∫
- ‚úÖ Fallback —Ü–µ–ø–æ—á–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Batch processor –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ

---

**–≠—Ç–∞–ø 2:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≠—Ç–∞–ø—É 3:** ‚úÖ 100%  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:** ‚úÖ 100%

